<!doctype html>
<html>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>RollCall Sign</title>

  <body style="font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height:1.5">
    <h1>RollCall</h1>

    <form id="f" autocomplete="off">
      <div><strong>Session</strong>: <span id="sessionSpan"></span></div>

      <!-- name input -->
      <label>Name<br>
        <input id="name" required>
      </label>
      <br><br>

      <!-- ASU ID input -->
      <label>ASU ID<br>
        <input id="asuId" required>
      </label>
      <br><br>

      <!-- secret code input (displayed on professor's screen) -->
      <label>Code (on screen)<br>
        <input id="code" required inputmode="numeric" pattern="[0-9]{6}" maxlength="6">
      </label>
      <br><br>

      <button id="btn">Sign In</button>
    </form>

    <p id="msg"></p>

    <script>
      const params = new URLSearchParams(location.search); // read session from url
      const sessionId = params.get('session') || ''; // use empty string if missing
      document.getElementById('sessionSpan').textContent = sessionId || '(missing)'; // show session id

      const form = document.getElementById('f');
      const btn  = document.getElementById('btn');
      const msg  = document.getElementById('msg');

      // Block submit if session is missing
      if (!sessionId) {
        msg.textContent = "Missing session id. Please rescan the QR code.";
        btn.disabled = true; // prevents submit w/o session
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault(); // stay on page while form is submitted

        // trim input values
        const name  = document.getElementById('name').value.trim();
        const asuId = document.getElementById('asuId').value.trim();
        const code  = document.getElementById('code').value.trim();
    
        if (!/^\d{6}$/.test(code)) { // check if code is 6 digits
          msg.textContent = "Code must be exactly 6 digits.";
          return; // stop if code is not 6 digits
        }
    
        btn.disabled = true; // stops double clicks 
        msg.textContent = 'Submittingâ€¦'; // for user feedback 
    
        try {
          const u = new URL("https://script.google.com/macros/s/AKfycbwqKbqvw0f62eFB_MYjIh5Qd1Jzp82GtPmTI-lofenVFw45tDKRQ86yGx-4LFiHU6U3kQ/exec"); // google apps script endpoint
          u.searchParams.set("path", "sign"); // route to sign 
          u.searchParams.set("sessionId", sessionId); // include current session
          u.searchParams.set("name", name); 
          u.searchParams.set("asuId", asuId);
          u.searchParams.set("code", code);
    
          const res  = await fetch(u, { method: "GET", mode: "cors" });
          const json = await res.json(); // parse JSON response
    
          if (json.ok) {
            msg.textContent = "Signed in."; // success!
            form.reset(); // clear fields for next sign-in
          } else {
            msg.textContent = "Not accepted: " + (json.reason || "unknown"); // fail with explanation message
          }
        } catch (err) {
          msg.textContent = "Network error: " + err.message; // fail with error message
        } finally {
          btn.disabled = false; // reenable button
        }
      });
    </script>
  </body>
</html>
