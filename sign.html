<!doctype html>
<html>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RollCall Sign</title>

  <body style="font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height:1.5">
    <h1>RollCall</h1>

    <form id="f" autocomplete="off">
      <div><strong>Session</strong>: <span id="sessionSpan"></span></div>

      <!-- name input -->
      <label>Name<br>
        <input id="name" required>
      </label>
      <br><br>

      <!-- ASU ID input -->
      <label>ASU ID<br>
        <input id="asuId" required>
      </label>
      <br><br>

      <!-- secret code input (displayed on professor's screen) -->
      <label>Code (on screen)<br>
        <input id="code" required inputmode="numeric" pattern="[0-9]{6}" maxlength="6">
      </label>
      <br><br>

      <button id="btn">Sign In</button>
    </form>

    <p id="msg"></p>

    <script>
      const params = new URLSearchParams(location.search);
      const sessionId = params.get('session') || '';
      document.getElementById('sessionSpan').textContent = sessionId || '(missing)';

      const form = document.getElementById('f');
      const btn  = document.getElementById('btn');
      const msg  = document.getElementById('msg');

      // Block submit if session is missing
      if (!sessionId) {
        msg.textContent = "Missing session id. Please rescan the QR code.";
        btn.disabled = true;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name  = document.getElementById('name').value.trim();
        const asuId = document.getElementById('asuId').value.trim();
        const code  = document.getElementById('code').value.trim();

        // client-side validation (server still checks)
        if (!/^\d{6}$/.test(code)) {
          msg.textContent = "Code must be exactly 6 digits.";
          return;
        }

        const payload = { path: 'sign', sessionId, name, asuId, code };

        btn.disabled = true;
        msg.textContent = 'Submitting…';

        try {
          const res = await fetch("https://script.google.com/macros/s/AKfycbz8xhAeDTG_am2kyvXrmKn8bzIB3PtBzLI-5zEV7HYL_q0MdbNCxAlyNV9NUPASgQlX/exec", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const json = await res.json();
          if (json.ok) {
            msg.textContent = "Signed in ✅";
            form.reset();
          } else {
            msg.textContent = "Not accepted: " + (json.reason || "unknown");
          }
        } catch (err) {
          msg.textContent = "Network error: " + err.message;
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
